version: '3.7'

services:
    cache:
        image: redis:4.0.11
        restart: always
        command: redis-server --requirepass radiaTest1234 --bind 0.0.0.0 --protected-mode no
        ports:
            - 6379:6379
        volumes:
            - /data
            - /var/lib/redis
            - /var/log/redis

    queue:
        image: rabbitmq:3.7.23-management
        restart: always
        ports:
            - 5672:5672
            - 15672:15672
        volumes:
            - /var/lib/rabbitmq
            - /var/log/rabbitmq
        environment:
            RABBITMQ_DEFAULT_USER: radiaTest
            RABBITMQ_DEFAULT_PASS: 1234
            RABBITMQ_DEFAULT_VHOST: radiaTest

    db:
        image: mariadb:10.5.10
        restart: always
        ports:
            - 3306:3306
        volumes:
            - /var/lib/mysql
            - /var/log/mysql
            - /usr/share/zoneinfo/Asia/Shanghai:/etc/localtime
        environment:
            MYSQL_ROOT_PASSWORD: 1234
            MYSQL_DATABASE: radiaTest

    nginx:
        image: nginx:1.21.5
        restart: always
        ports:
            - 8080:8080
            - 443:443
        volumes:
            - /var/lib/nginx
            - /var/log/nginx
            - /usr/share/radiaTest/dist:/usr/share/nginx/html
            - /etc/nginx:/etc/nginx
        ulimits:
            nproc: 65535
            nofile:
                soft: 10240
                hard: 20000

    supervisor:
        image: supervisor:radiaTest
        build:
            context: ./supervisor
            dockerfile: Dockerfile
        restart: always
        ports:
            - 21500:21500
        volumes:
            - /var/log/radiaTest-server:/opt/radiaTest/radiaTest-server/log
        ulimits:
            nproc: 65535
            nofile:
                soft: 10240
                hard: 20000
        depends_on:
            - queue
            - cache
            - db
